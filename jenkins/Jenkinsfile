#!groovy

// утилиты
def checkDirectoryChanges(path) {
    try {
        sh "git diff --quiet --exit-code HEAD~1..HEAD ${path}/"
        echo ' === Без сборки, в директории нет изменений === '
        return false
    } catch (err) {
        return true
    }
}

def getShellScript(name) {
    return "./jenkins/scripts/${name}.sh"
}

properties(
    [
        disableConcurrentBuilds(),
        buildDiscarder(
            logRotator(
                numToKeepStr: '5',
                artifactNumToKeepStr: '5'
            )
        )
    ]
)

node {
    checkout scm

    stage('Build backend') {
        if (checkDirectoryChanges('backend')) {
            sh "chmod +x jenkins/scripts/backend_build.sh"
            sh "./jenkins/scripts/backend_build.sh"
        }
    }

    stage("Build frontend") {
        if (checkDirectoryChanges('frontend')) {
            sh "chmod +x jenkins/scripts/frontend_build.sh"
            sh "./jenkins/scripts/frontend_build.sh"
        }
    }
}
