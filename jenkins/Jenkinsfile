#!groovy

// утилиты
def checkDirectoryChanges(path) {
    try {
        sh "git diff --quiet --exit-code HEAD~1..HEAD ${path}/"
        echo ' === Без сборки, в директории нет изменений === '
        return false
    } catch (err) {
        return true
    }
}

def getShellScript(name) {
    return "./jenkins/scripts/${name}.sh"
}

properties(
    [
        disableConcurrentBuilds(),
        buildDiscarder(
            logRotator(
                numToKeepStr: '5',
                artifactNumToKeepStr: '5'
            )
        )
    ]
)

node {
    checkout scm

    stage('Build_backend') {
        if (checkDirectoryChanges('backend')) {
            sh "chmod +x jenkins/scripts/docker-stop.sh"
            sh getShellScript('docker-stop')
            docker
                .image('zayanimal/nest-backend:v1')
                .run('-d -v $(pwd)/backend:/var/www/interaktiv -p 8000:8000 --name=nest-backend zayanimal/nest-backend:v1')
        }
    }

    stage("Build frontend") {
        if (checkDirectoryChanges('frontend')) {
            sh "chmod +x jenkins/scripts/frontend_build.sh"
        }
    }
}
