#!groovy

properties(
    [
        disableConcurrentBuilds(),
        buildDiscarder(
            logRotator(
                numToKeepStr: '5',
                artifactNumToKeepStr: '5'
            )
        )
    ]
)

node {
    checkout scm

    stage('Остановка контейнера') {
        sh '''
            if [[ -n $(docker ps --filter "name=react-frontend-dev" -qa) ]]
            then
                docker stop react-frontend-dev
            fi
        '''
    }

    stage('Удаление контейнера') {
        sh '''
            if [[ -n $(docker ps --filter "name=react-frontend-dev" -qa) ]]
            then
                docker rm react-frontend-dev
            fi
        '''
    }

    stage('Удаление образа') {
        sh '''
            if [[ -n $(docker images -q zayanimal/react-frontend-dev:v1) ]]
            then
                docker rmi zayanimal/react-frontend-dev:v1
            fi
        '''
    }

    stage('Сборка контейнера') {
        sh 'chmod +x jenkins/scripts/frontend-dev.sh'
        sh './jenkins/scripts/frontend-dev.sh'
    }

    stage('Очистка временных образов') {
        sh 'docker images -q -f dangling=true | xargs --no-run-if-empty docker rmi'
    }
}
